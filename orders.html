<section id="orders">
  <h2>Orders Assignment</h2>

  <!-- Form Assign Order -->
  <form id="order-form">
    <label>Customer:</label><br>
    <select id="customer" required>
      <option value="">Pilih Customer</option>
    </select><br>

    <label>Origin:</label><br>
    <input type="text" id="origin" placeholder="Origin" required><br>

    <label>Destination:</label><br>
    <input type="text" id="destination" placeholder="Destination" required><br>

    <label>Type Unit:</label><br>
    <input type="text" id="type-unit" placeholder="Type Unit" required><br>

    <button type="submit">Assign Order</button>
  </form>

  <p id="order-message"></p>

  <!-- Tabel Orders -->
  <table border="1" id="orders-table">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Origin</th>
        <th>Destination</th>
        <th>Type Unit</th>
        <th>Assigned Unit</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
async function loadCustomers() {
  const { data: customers } = await supabase.from('customers').select('*');
  const customerSelect = document.getElementById('customer');
  customers.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.customer_name;
    customerSelect.appendChild(option);
  });
}

// Panggil saat load halaman
loadCustomers();

const orderForm = document.getElementById('order-form');
const orderMessage = document.getElementById('order-message');
const ordersTable = document.getElementById('orders-table').querySelector('tbody');

orderForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const customerId = document.getElementById('customer').value;
  const origin = document.getElementById('origin').value;
  const destination = document.getElementById('destination').value;
  const typeUnit = document.getElementById('type-unit').value;

  // Ambil data customer untuk nama
  const { data: customerData } = await supabase
    .from('customers')
    .select('*')
    .eq('id', customerId)
    .single();

  // Cari unit yang sesuai type_unit
  const { data: units } = await supabase
    .from('units')
    .select('*')
    .eq('type', typeUnit)
    .limit(1);

  if (!units || units.length === 0) {
    orderMessage.textContent = "Unit tipe ini tidak tersedia.";
    return;
  }

  const assignedUnitId = units[0].id;

  // Insert order
  const { data, error } = await supabase.from('orders').insert([{
    customer: customerData.customer_name,
    origin,
    destination,
    type_unit: typeUnit,
    assigned_unit: assignedUnitId,
    status: 'pending'
  }]);

  if (error) {
    orderMessage.textContent = "Gagal assign order: " + error.message;
    return;
  }

  orderMessage.textContent = `Order berhasil dibuat, unit ${units[0].police_no} dipilih otomatis.`;

  // Tambah ke tabel HTML
  const row = ordersTable.insertRow();
  row.innerHTML = `
    <td>${data[0].id}</td>
    <td>${customerData.customer_name}</td>
    <td>${origin}</td>
    <td>${destination}</td>
    <td>${typeUnit}</td>
    <td>${units[0].police_no}</td>
    <td>pending</td>
  `;
});
</script>
